name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint || echo "Linting completed with warnings"
      
    - name: Build project
      run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Stop application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 30s
        script: |
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
          pm2 stop aldalinde 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
          pm2 delete aldalinde 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          sleep 3

    - name: Update code and build
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 300s
        script: |
          cd /var/www/aldalinde
          echo "üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥..."
          git stash push -m "Auto stash before deploy" || echo "–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å"
          git pull origin main
          
          echo "üßπ –û—á–∏—â–∞–µ–º –∫–µ—à..."
          rm -rf .next node_modules/.cache
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm ci --silent --maxsockets 1
          
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
          npm run build
          
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É..."
          ls -la .next/static/chunks/app/ | head -10 || echo "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

    - name: Start application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 60s
        script: |
          cd /var/www/aldalinde
          echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
          pm2 start npm --name "aldalinde" -- run start
          pm2 save
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          pm2 status

    - name: Diagnostic check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 60s
        script: |
          cd /var/www/aldalinde
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
          echo "–°—Ç–∞—Ç—É—Å PM2:"
          pm2 status
          echo "–õ–æ–≥–∏ PM2:"
          pm2 logs --lines 20
          echo "–ü–æ—Ä—Ç—ã:"
          netstat -tlnp | grep :3000 || echo "–ü–æ—Ä—Ç 3000 –Ω–µ –∑–∞–Ω—è—Ç"
          echo "–ü—Ä–æ—Ü–µ—Å—Å—ã Node:"
          ps aux | grep node | head -5
          echo "–†–∞–∑–º–µ—Ä .next:"
          du -sh .next/
          echo "–§–∞–π–ª—ã –≤ static/chunks:"
          ls -la .next/static/chunks/ | head -10
